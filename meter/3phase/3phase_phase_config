#!/bin/bash

source env_var.sh
source ${IOX_PATH}"/common.sh"
source ${IOX_PATH}"/iox.config"
source ${IOX_PATH}"/errors.sh"

LOG_OUT=${IOX_PATH}"/meter/3phase/out"
PHASE_LOG=${IOX_PATH}"/meter/3phase/phase_config_log"

subscribe_phase()
{	
	mosquitto_pub -t "glp/0/${SID}/fb/dev/${IOX_PROTOCOL}/${METER_DEV_NAME}/if/phase/0" -m '' -r 
	mosquitto_sub -t "glp/0/${SID}/fb/dev/${IOX_PROTOCOL}/${METER_DEV_NAME}/if/phase/0" > ${LOG_OUT}
}

parse_out()
{
	sleep 20
	L1_Phase=$(cat ${LOG_OUT} | python -c 'import sys, json;b=json.load(sys.stdin)["cpPhaseEnable"]; c=b["value"];print c["L1_Phase"]')
	L2_Phase=$(cat ${LOG_OUT} | python -c 'import sys, json;b=json.load(sys.stdin)["cpPhaseEnable"]; c=b["value"];print c["L2_Phase"]')
	L3_Phase=$(cat ${LOG_OUT} | python -c 'import sys, json;b=json.load(sys.stdin)["cpPhaseEnable"]; c=b["value"];print c["L3_Phase"]')
#	echo "L1 : ${L1_Phase} L2 : ${L2_Phase} L3 : ${L3_Phase}"
	if [ ${L1_Phase} -eq ${1} ] &&  [ ${L2_Phase} -eq ${2} ] && [ ${L3_Phase} -eq ${3} ];
	then
    	RESULT="PASS"
	else
    	RESULT="FAIL"
	fi
	rm ${LOG_OUT}
}

3phase_phase_config_test1()
{
	subscribe_phase &
	mosquitto_pub -m '{"cpPhaseEnable":{"value": {"L1_Phase":1,"L2_Phase":0,"L3_Phase":0}},"cpCtRatio":{"L1_ctRatio":{"multiplier":10},"L2_ctRatio":{"multiplier":10},"L3_ctRatio":{"multiplier":10}},"nvoVoltageRMS":{"monitor":{"rate":500,"cat":"data","inFeedback":false,"report":"change","throttle":21,"threshold":31}},"nvoVoltageAvg":{"monitor":{"rate":300,"cat":"data","inFeedback":false,"report":"change","throttle":21,"threshold":31}},"nvoCurrentRMS":{"monitor":{"rate":550,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoActiveEnergy":{"monitor":{"rate":250,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoReactEnergy":{"monitor":{"rate":300,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoAppEnergy":{"monitor":{"rate":350,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPhaseActEnergy":{"monitor":{"rate":400,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPhaseRctEnergy":{"monitor":{"rate":450,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPhaseAppEnergy":{"monitor":{"rate":500,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPower":{"monitor":{"rate":550,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPhaseActPwr":{"monitor":{"rate":600,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPhaseReactPwr":{"monitor":{"rate":650,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPhaseAppPwr":{"monitor":{"rate":700,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPowerStatus":{"monitor":{"rate":500,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPhaseFrequency":{"monitor":{"rate":400,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}}}' -t "glp/0/${SID}/rq/dev/${IOX_PROTOCOL}/${METER_DEV_NAME}/if/phase/0"
	parse_out 1 0 0
	echo "3phase_phase_config_test1 | RESULT : ${RESULT}"
	echo "=========================================================================================="
	unset RESULT L1_Phase L2_Phase L3_Phase
}

3phase_phase_config_test2()
{
	subscribe_phase &
	mosquitto_pub -m '{"cpPhaseEnable":{"value": {"L1_Phase":0,"L2_Phase":1,"L3_Phase":0}},"cpCtRatio":{"L1_ctRatio":{"multiplier":10},"L2_ctRatio":{"multiplier":10},"L3_ctRatio":{"multiplier":10}},"nvoVoltageRMS":{"monitor":{"rate":500,"cat":"data","inFeedback":false,"report":"change","throttle":21,"threshold":31}},"nvoVoltageAvg":{"monitor":{"rate":300,"cat":"data","inFeedback":false,"report":"change","throttle":21,"threshold":31}},"nvoCurrentRMS":{"monitor":{"rate":550,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoActiveEnergy":{"monitor":{"rate":250,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoReactEnergy":{"monitor":{"rate":300,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoAppEnergy":{"monitor":{"rate":350,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPhaseActEnergy":{"monitor":{"rate":400,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPhaseRctEnergy":{"monitor":{"rate":450,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPhaseAppEnergy":{"monitor":{"rate":500,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPower":{"monitor":{"rate":550,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPhaseActPwr":{"monitor":{"rate":600,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPhaseReactPwr":{"monitor":{"rate":650,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPhaseAppPwr":{"monitor":{"rate":700,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPowerStatus":{"monitor":{"rate":500,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPhaseFrequency":{"monitor":{"rate":400,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}}}' -t "glp/0/${SID}/rq/dev/${IOX_PROTOCOL}/${METER_DEV_NAME}/if/phase/0"
	parse_out 0 1 0
	echo "3phase_phase_config_test2 | RESULT : ${RESULT}"
	echo "=========================================================================================="
	unset RESULT L1_Phase L2_Phase L3_Phase
}

3phase_phase_config_test3()
{
	subscribe_phase &
	mosquitto_pub -m '{"cpPhaseEnable":{"value": {"L1_Phase":0,"L2_Phase":0,"L3_Phase":1}},"cpCtRatio":{"L1_ctRatio":{"multiplier":10},"L2_ctRatio":{"multiplier":10},"L3_ctRatio":{"multiplier":10}},"nvoVoltageRMS":{"monitor":{"rate":500,"cat":"data","inFeedback":false,"report":"change","throttle":21,"threshold":31}},"nvoVoltageAvg":{"monitor":{"rate":300,"cat":"data","inFeedback":false,"report":"change","throttle":21,"threshold":31}},"nvoCurrentRMS":{"monitor":{"rate":550,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoActiveEnergy":{"monitor":{"rate":250,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoReactEnergy":{"monitor":{"rate":300,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoAppEnergy":{"monitor":{"rate":350,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPhaseActEnergy":{"monitor":{"rate":400,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPhaseRctEnergy":{"monitor":{"rate":450,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPhaseAppEnergy":{"monitor":{"rate":500,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPower":{"monitor":{"rate":550,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPhaseActPwr":{"monitor":{"rate":600,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPhaseReactPwr":{"monitor":{"rate":650,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPhaseAppPwr":{"monitor":{"rate":700,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPowerStatus":{"monitor":{"rate":500,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPhaseFrequency":{"monitor":{"rate":400,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}}}' -t "glp/0/${SID}/rq/dev/${IOX_PROTOCOL}/${METER_DEV_NAME}/if/phase/0"
	parse_out 0 0 1
	echo "3phase_phase_config_test3 | RESULT : ${RESULT}"
	echo "=========================================================================================="
	unset RESULT L1_Phase L2_Phase L3_Phase
}

3phase_phase_config_test4()
{
	subscribe_phase &
	mosquitto_pub -m '{"cpPhaseEnable":{"value": {"L1_Phase":1,"L2_Phase":1,"L3_Phase":1}},"cpCtRatio":{"L1_ctRatio":{"multiplier":10},"L2_ctRatio":{"multiplier":10},"L3_ctRatio":{"multiplier":10}},"nvoVoltageRMS":{"monitor":{"rate":500,"cat":"data","inFeedback":false,"report":"change","throttle":21,"threshold":31}},"nvoVoltageAvg":{"monitor":{"rate":300,"cat":"data","inFeedback":false,"report":"change","throttle":21,"threshold":31}},"nvoCurrentRMS":{"monitor":{"rate":550,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoActiveEnergy":{"monitor":{"rate":250,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoReactEnergy":{"monitor":{"rate":300,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoAppEnergy":{"monitor":{"rate":350,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPhaseActEnergy":{"monitor":{"rate":400,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPhaseRctEnergy":{"monitor":{"rate":450,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPhaseAppEnergy":{"monitor":{"rate":500,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPower":{"monitor":{"rate":550,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPhaseActPwr":{"monitor":{"rate":600,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPhaseReactPwr":{"monitor":{"rate":650,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPhaseAppPwr":{"monitor":{"rate":700,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPowerStatus":{"monitor":{"rate":500,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}},"nvoPhaseFrequency":{"monitor":{"rate":400,"cat":"data","inFeedback":false,"report":"change","throttle":22,"threshold":32}}}' -t "glp/0/${SID}/rq/dev/${IOX_PROTOCOL}/${METER_DEV_NAME}/if/phase/0"
	parse_out 1 1 1
	echo "3phase_phase_config_test4 | RESULT : ${RESULT}"
	echo "=========================================================================================="
	unset RESULT L1_Phase L2_Phase L3_Phase
}


3phase_phase_config_test1
3phase_phase_config_test2
3phase_phase_config_test3
3phase_phase_config_test4

kill_process

